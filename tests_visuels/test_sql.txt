# a) Liste CG par laps de temps de création

-- Cartes grises créées par période personnalisée
SELECT *
FROM cartes_grises cg
JOIN proprietaires p on cg.proprietaire_id=p.id
JOIN modeles mo on cg.modele_id=mo.id
JOIN marques ma on mo.marque_id=ma.id
WHERE cg.created_at BETWEEN '2000-01-01' AND '2030-01-01'
ORDER by cg.created_at DESC;

# b) Lister CG par nom et prénom, ou séquence de caractère nom


SELECT *
FROM cartes_grises cg
JOIN proprietaires p ON cg.proprietaire_id = p.id
JOIN modeles mo ON cg.modele_id = mo.id
JOIN marques ma ON mo.marque_id = ma.id
WHERE p.nom LIKE '%MAR%' 
   OR p.prenom LIKE '%MAR%'
ORDER BY p.nom, p.prenom;


# c) Lister par numéro de plaque ou séquence de numéro de plaque



-- Recherche par plaque 
SELECT *
FROM cartes_grises cg
JOIN proprietaires p ON cg.proprietaire_id = p.id
JOIN modeles mo ON cg.modele_id = mo.id
JOIN marques ma ON mo.marque_id = ma.id
WHERE cg.numero_immatriculation LIKE 'AB%'
ORDER BY cg.numero_immatriculation;


-- Recherche par numéro dans la plaque (ex: toutes les plaques avec "123")
SELECT *
FROM cartes_grises cg
JOIN proprietaires p ON cg.proprietaire_id = p.id
JOIN modeles mo ON cg.modele_id = mo.id
JOIN marques ma ON mo.marque_id = ma.id
WHERE cg.numero_immatriculation LIKE '%123%'
ORDER BY cg.numero_immatriculation;



# d) Lister par marque/modèle et par nb de véhicules immatriculés par marque


-- Nombre de véhicules par marque

SELECT 
    ma.nom AS marque,
    COUNT(*) AS nombre_vehicules,
    COUNT(DISTINCT mo.id) AS nombre_modeles_differents
FROM cartes_grises cg
JOIN modeles mo ON cg.modele_id = mo.id
JOIN marques ma ON mo.marque_id = ma.id
GROUP BY ma.nom
ORDER BY ma.nom;

-- Nombre de véhicules par marque et modèle

SELECT 
    ma.nom AS marque,
    mo.modele,
    mo.type_vehicule,
    COUNT(*) AS nombre_vehicules
FROM cartes_grises cg
JOIN modeles mo ON cg.modele_id = mo.id
JOIN marques ma ON mo.marque_id = ma.id
GROUP BY ma.nom, mo.modele, mo.type_vehicule
ORDER BY ma.nom;

-- Top 5 des marques les plus immatriculées
SELECT 
    ma.nom AS marque,
    COUNT(*) AS nombre_vehicules
FROM cartes_grises cg
JOIN modeles mo ON cg.modele_id = mo.id
JOIN marques ma ON mo.marque_id = ma.id
GROUP BY ma.nom
ORDER BY COUNT(*) DESC
LIMIT 5;

-- Véhicules d'une marque spécifique avec détails
SELECT *
FROM cartes_grises cg
JOIN modeles mo ON cg.modele_id = mo.id
JOIN marques ma ON mo.marque_id = ma.id
JOIN proprietaires p ON cg.proprietaire_id = p.id
WHERE ma.nom = 'PEUGEOT'
ORDER BY cg.date_premiere_immat DESC;


# e) Lister véhicules par année d'ancienneté et ou par degré de pollution


-- Véhicules par année d'ancienneté

SELECT *
FROM cartes_grises cg
JOIN modeles mo ON cg.modele_id = mo.id
JOIN marques ma ON mo.marque_id = ma.id
ORDER BY YEAR(cg.date_premiere_immat) DESC;


-- Véhicules par degré de pollution 
SELECT *
FROM cartes_grises cg
JOIN modeles mo ON cg.modele_id = mo.id
JOIN marques ma ON mo.marque_id = ma.id
WHERE cg.emission_co2_g_km IS NOT NULL
ORDER BY cg.emission_co2_g_km;

-- Statistiques de pollution par classe environnementale
SELECT 
    cg.classe_environnementale,
    COUNT(*) AS nombre_vehicules,
    AVG(cg.emission_co2_g_km) AS emission_co2_moyenne,
    MIN(cg.emission_co2_g_km) AS emission_co2_min,
    MAX(cg.emission_co2_g_km) AS emission_co2_max
FROM cartes_grises cg
WHERE cg.classe_environnementale IS NOT NULL 
  AND cg.emission_co2_g_km IS NOT NULL
GROUP BY cg.classe_environnementale
ORDER BY cg.classe_environnementale;

-- Véhicules électriques et hybrides (faible pollution)

SELECT *
FROM cartes_grises cg
JOIN modeles mo ON cg.modele_id = mo.id
JOIN marques ma ON mo.marque_id = ma.id
JOIN proprietaires p ON cg.proprietaire_id = p.id
WHERE cg.carburant_energie IN ('Diesel')
ORDER BY cg.carburant_energie, ma.nom;

